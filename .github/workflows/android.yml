name: Android CI - build debug APK (auto-detect)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show repo root
        run: |
          echo "Root listing:"
          ls -la

      - name: Find Gradle root (settings.gradle or settings.gradle.kts)
        id: find_root
        run: |
          root=$(find . -maxdepth 4 -type f \( -name "settings.gradle" -o -name "settings.gradle.kts" \) -printf '%h\n' | sort -u | head -n 1)
          if [ -z "$root" ]; then
            echo "no_root=true" >> $GITHUB_OUTPUT
            echo "No Gradle settings file found within depth 4."
            exit 1
          fi
          root=${root#./}
          echo "gradle_root=$root" >> $GITHUB_OUTPUT
          echo "Found Gradle root: $root"
          ls -la "$root" || true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Gradle (for projects without wrapper)
        uses: gradle/gradle-build-action@v2

      - name: Build debug APK (use wrapper if present)
        run: |
          ROOT="${{ steps.find_root.outputs.gradle_root }}"
          echo "Using Gradle root: $ROOT"
          cd "$ROOT"
          # prefer wrapper in this root
          if [ -x ./gradlew ]; then
            chmod +x ./gradlew
            ./gradlew assembleDebug --no-daemon
          elif [ -x ../gradlew ]; then
            chmod +x ../gradlew
            ../gradlew assembleDebug --no-daemon
          else
            gradle assembleDebug --no-daemon
          fi

      - name: Upload debug APK artifact (search all)
        uses: actions/upload-artifact@v4
        with:
          name: kraigsandroid-debug-apks
          path: '**/build/outputs/apk/debug/*.apk'
